[config]

# Documentation for this use case can be found at
# https://metplus.readthedocs.io/en/latest/generated/model_applications/s2s_stratosphere/UserScript_fcstGFS_obsERA_StratosphereBias.html

# For additional information, please see the METplus Users Guide.
# https://metplus.readthedocs.io/en/latest/Users_Guide

###
# Processes to run
# https://metplus.readthedocs.io/en/latest/Users_Guide/systemconfiguration.html#process-list
###
#PROCESS_LIST = UserScript(create_obs_eofs_filelist), UserScript(compute_plot_qbo), StatAnalysis(qbo_bias)
PROCESS_LIST = UserScript(compute_plot_qbo), StatAnalysis(qbo_bias)


###
# Time Info
# LOOP_BY options are INIT, VALID, RETRO, and REALTIME
# If set to INIT or RETRO:
#   INIT_TIME_FMT, INIT_BEG, INIT_END, and INIT_INCREMENT must also be set
# If set to VALID or REALTIME:
#   VALID_TIME_FMT, VALID_BEG, VALID_END, and VALID_INCREMENT must also be set
# LEAD_SEQ is the list of forecast leads to process
# https://metplus.readthedocs.io/en/latest/Users_Guide/systemconfiguration.html#timing-control
###

LOOP_BY = INIT
INIT_TIME_FMT = %Y%m%d%H
INIT_BEG = 2017100100
#INIT_BEG = 2018020100
INIT_END = 2018022821
INIT_INCREMENT = 86400
LEAD_SEQ = begin_end_incr(0,21,3)


USER_SCRIPT_RUNTIME_FREQ = RUN_ONCE

LOOP_ORDER = processes

SCRUB_STAGING_DIR = False


###
# User Environment Variables
###
[user_env_vars]
# Variable to determine if Zonal and Meridional means are need to be computed on the data used
# to create EOFS.  Set to True to compute zonal and meridional means.  If set to False, a file 
# should be provided in EOF_DATA_FILE_NAME that specifies the location of a dataset with zonal
# and meridional means.  The data should have the coordinates (time, pressure)
# Note, this is only for EOF calculation, and not for the data used to create plots.
COMPUTE_EOF_ZONAL_MERIDIONAL_MEAN = False
# Ignored if the above is set to True
EOF_DATA_FILE_NAME = {INPUT_BASE}/erai_zonal_mean_u.nc

# Option to save out the Zonal/Meridional Mean data to be used to compute EOFs
SAVE_EOF_ZONAL_MERIDIONAL_MEAN = False
# Name of the output Zonal/meridional mean file.  Ignored if The above is set to False
ZONAL_MERIDIONAL_MEAN_EOF_FILE_NAME = {INPUT_BASE}/erai_zonal_mean_u.nc

# Name of forecast variables for time, latitude, longitude, and U, and
# dimensions for latitude and longitude
FCST_TIME_VAR = time 
FCST_LAT_VAR = latitude
FCST_U_VAR = u
FCST_LON_DIM = lon
FCST_LAT_DIM = lat

# Name of observation variables for time, latitude, longitude, and U and
# dimensions for latitude and longitude
OBS_TIME_VAR = time
OBS_LAT_VAR = latitude
OBS_U_VAR = u
OBS_LON_DIM = lon
OBS_LAT_DIM = lat

# Minimum and maximum pressure levels to use in the QBO calculation
PRES_LEV_MIN = 10
PRES_LEV_MAX = 100

# Minimum and maximim latitude to use in the QBO calculation
LAT_MIN = -10
LAT_MAX = 10

MODEL_NAME = GFS

OUTPUT_DIR = {OUTPUT_BASE}/s2s_stratosphere/UserScript_fcstGFS_obsERA_StratosphereQBO

# Plot Settings
# Settings for the Circut Phase Diagram(s)
# List or single value of start times, each of which will have a phase diagram created 
PLOT_START_DATES = 10-1-2017
# Number of days for each diagram.  If the PLOT_START_DATES contains more than one value and
# PLOT_STAT_DATES[0]+PLOT_PERIODS != PLOT_START_DATES[1], the data between 
# PLOT_STAT_DATES[0]+PLOT_PERIODS and PLOT_START_DATES[1] will be omitted
PLOT_PERIODS = 151
# Full path to the output name of the phase circuits plot
PLOT_PHASE_CIRCUTS_OUTPUT_NAME = ERA_GFS_QBO_circuits.png

# Title and output name of the phase space plot
PLOT_PHASE_SPACE_TITLE = QBO Phase Space from ERA5 (10/2017 - 2/2018)
PLOT_PHASE_SPACE_OUTPUT_NAME = ERA5_QBO_PhaseSpace.png

# Time Series plot output name
PLOT_TIME_SERIES_TITLE_30 = ERA5 and GFS Zonal Mean U at 30mb (10/2017 - 2/2018)
PLOT_TIME_SERIES_OUTPUT_NAME_30 = ERA_GFS_timeseries_30mb_u_201710_201802.png
PLOT_TIME_SERIES_TITLE_50 = ERA5 and GFS Zonal Mean U at 50mb (10/2017 - 2/2018)
PLOT_TIME_SERIES_OUTPUT_NAME_50 = ERA_GFS_timeseries_50mb_u_201710_201802.png


###
# Creates the file listing for the EOF creation UserScript Settings
# https://metplus.readthedocs.io/en/latest/Users_Guide/wrappers.html#userscript
###
[create_obs_eofs_filelist]
INIT_BEG = 1991010100
INIT_END = 2020123121
INIT_INCREMENT = 86400
LEAD_SEQ = 0

# Template of filenames to input to the user-script
USER_SCRIPT_INPUT_TEMPLATE = {INPUT_BASE}/ERA/{valid?fmt=%Y%m}/ERA_{valid?fmt=%Y%m%d%H}.nc

# Name of the file containing the listing of input files
# The option is OBS_EOF_INPUT; FCST_EOF_INPUT is not supported
# *** Make sure the order is the same as the order of templates listed in USER_SCRIPT_INPUT_TEMPLATE
USER_SCRIPT_INPUT_TEMPLATE_LABELS = OBS_EOF_INPUT

USER_SCRIPT_COMMAND = echo Populated file list for obs EOF Input


###
# QBO Calculation and plotting UserScript Settings
# https://metplus.readthedocs.io/en/latest/Users_Guide/wrappers.html#userscript
###
[compute_plot_qbo]
USER_SCRIPT_RUNTIME_FREQUENCY = RUN_ONCE

# Template of filenames to input to the user-script
USER_SCRIPT_INPUT_TEMPLATE = {INPUT_BASE}/ERA/{valid?fmt=%Y%m}/ERA_{valid?fmt=%Y%m%d%H}.nc, {INPUT_BASE}/GFS/GFS_{init?fmt=%Y%m%d%H}_f{lead?fmt=%HHH}h.nc

# Name of the file containing the listing of input files
# The options are OBS_INPUT and FCST_INPUT
# *** Make sure the order is the same as the order of templates listed in USER_SCRIPT_INPUT_TEMPLATE
USER_SCRIPT_INPUT_TEMPLATE_LABELS = OBS_INPUT, FCST_INPUT

USER_SCRIPT_COMMAND = /glade/u/home/kalb/stratosphere/METplus/parm/use_cases/model_applications/s2s_stratosphere/UserScript_fcstGFS_obsERA_StratosphereQBO/stratosphere_qbo_driver.py


[qbo_bias]
MODEL1 = GFS
MODEL1_OBTYPE = ADPUPA

STAT_ANALYSIS_CONFIG_FILE = {PARM_BASE}/met_config/STATAnalysisConfig_wrapped

STAT_ANALYSIS_JOB1 = -job aggregate_stat -line_type MPR -out_line_type CNT -fcst_var QBO_U -by FCST_LEV -out_stat [out_stat_file]_zonal_wind_CNT.stat
STAT_ANALYSIS_JOB2 = -job aggregate_stat -line_type MPR -out_line_type CNT -fcst_var QBO_U -by FCST_LEV,DESC -out_stat [out_stat_file]_zonal_wind_byphase_CNT.stat

MODEL_LIST = {MODEL1}
FCST_LEAD_LIST = 21

GROUP_LIST_ITEMS = MODEL_LIST
LOOP_LIST_ITEMS = 

MODEL1_STAT_ANALYSIS_LOOKIN_DIR = {OUTPUT_BASE}/s2s_stratosphere/UserScript_fcstGFS_obsERA_StratosphereQBO/mpr 

STAT_ANALYSIS_OUTPUT_DIR = {OUTPUT_BASE}/s2s_stratosphere/UserScript_fcstGFS_obsERA_StratosphereQBO/StatAnalysis

MODEL1_STAT_ANALYSIS_OUT_STAT_TEMPLATE = {model?fmt=%s}_ERA_{obs_valid_beg?fmt=%Y%m%d}_{obs_valid_end?fmt=%Y%m%d}_{lead?fmt=%H%M%S}L
